<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CardioCare | IA Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #0d6efd; --secondary-bg: #f4f7f6; }
        body { background-color: var(--secondary-bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { height: 100vh; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); position: fixed; width: 250px; }
        .main-content { margin-left: 250px; padding: 30px; }
        .hidden { display: none !important; }
        .patient-header { background: linear-gradient(135deg, #0d6efd, #0099ff); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .diag-card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .diag-card:hover { transform: translateY(-5px); }
        .ai-panel { background: #f8f9fa; border-left: 4px solid #0d6efd; padding: 20px; border-radius: 5px; }
        .factor-tag { background: #e9ecef; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; margin-right: 5px; display: inline-block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column">
        <h4 class="text-primary mb-4"><i class="fas fa-heartbeat"></i> CardioCare</h4>
        <div id="user-info" class="mb-4 text-muted small">Chargement...</div>

        <div id="menu-admin" class="hidden">
            <button class="btn btn-light w-100 text-start mb-2" onclick="showSection('admin-users')">
                <i class="fas fa-users-cog me-2"></i> Utilisateurs
            </button>
        </div>

        <div id="menu-doctor" class="hidden">
            <button class="btn btn-light w-100 text-start mb-2" onclick="showSection('doc-patients')">
                <i class="fas fa-user-injured me-2"></i> Liste Patients
            </button>
            <button class="btn btn-primary w-100 text-start mb-2" onclick="loadNewPatientForm()">
                <i class="fas fa-plus me-2"></i> Nouveau Dossier
            </button>
        </div>

        <div id="menu-patient" class="hidden">
            <button class="btn btn-primary w-100 text-start mb-2" onclick="loadPatientDashboard()">
                <i class="fas fa-file-medical me-2"></i> Mon Dossier
            </button>
        </div>

        <div class="mt-auto pt-5">
            <a href="/logout" class="btn btn-outline-danger w-100">
                <i class="fas fa-sign-out-alt me-2"></i> Déconnexion
            </a>
        </div>
    </div>

    <div class="main-content">
        <!-- ADMIN -->
        <div id="vue-admin-users" class="hidden">
            <h2 class="mb-4">Administration</h2>
            <div class="card p-4 border-0 shadow-sm mb-4">
                <h5><i class="fas fa-user-plus"></i> Créer un compte</h5>
                <div class="row g-2 mt-2">
                    <div class="col"><input id="new-nom" placeholder="Nom" class="form-control"></div>
                    <div class="col"><input id="new-prenom" placeholder="Prénom" class="form-control"></div>
                    <div class="col"><input id="new-email" placeholder="Email" class="form-control"></div>
                    <div class="col"><input id="new-pass" type="password" placeholder="Mot de passe" class="form-control"></div>
                    <div class="col">
                        <select id="new-role" class="form-select">
                            <option value="patient">Patient</option>
                            <option value="medecin">Médecin</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button onclick="createUser()" class="btn btn-success">Ajouter</button>
                    </div>
                </div>
            </div>
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <table class="table table-hover">
                        <thead><tr><th>Nom</th><th>Email</th><th>Rôle</th><th>Actions</th></tr></thead>
                        <tbody id="table-users"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MEDECIN : LISTE -->
        <div id="vue-doc-patients" class="hidden">
            <h2 class="mb-4">Patients suivis</h2>
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>Patient</th><th>Compte Lié</th><th>Dossier Médical</th><th>Action</th></tr>
                        </thead>
                        <tbody id="table-patients"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MEDECIN : NOUVEAU DOSSIER -->
        <div id="vue-doc-new-patient" class="hidden">
            <button onclick="showSection('doc-patients')" class="btn btn-link text-decoration-none ps-0 mb-3">← Retour</button>
            <h2>Nouveau Dossier Patient</h2>
            <div class="card p-4 border-0 shadow-sm mt-3" style="max-width: 700px;">
                <div class="mb-3">
                    <label class="form-label text-muted">Lier à un compte utilisateur (optionnel)</label>
                    <select id="select-existing-user" class="form-select" onchange="fillPatientForm()">
                        <option value="">-- Patient non inscrit (Anonyme) --</option>
                    </select>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-6"><input id="pat-nom" class="form-control" placeholder="Nom *" required></div>
                    <div class="col-md-6"><input id="pat-prenom" class="form-control" placeholder="Prénom *" required></div>
                    <div class="col-md-4">
                        <input id="pat-age" type="number" class="form-control" placeholder="Âge *" min="0" max="120" required>
                        <div class="form-text">Entre 0 et 120 ans</div>
                    </div>
                    <div class="col-md-4">
                        <select id="pat-sexe" class="form-select">
                            <option value="Masculin">Masculin</option>
                            <option value="Féminin">Féminin</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pat-diabete">
                            <label class="form-check-label">Le patient est diabétique</label>
                        </div>
                    </div>
                </div>
                <button onclick="createPatient()" class="btn btn-primary mt-4">Créer le Dossier</button>
            </div>
        </div>

        <!-- MEDECIN : DOSSIER & DIAGNOSTIC -->
        <div id="vue-doc-record" class="hidden">
            <button onclick="showSection('doc-patients')" class="btn btn-link text-decoration-none ps-0 mb-3">← Retour liste</button>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="record-title">Dossier Patient</h2>
                <div>
                    <input type="hidden" id="currentPatientId">
                    <button id="btn-edit-record"
                            class="btn btn-outline-secondary"
                            style="display:none;"
                            onclick="toggleEditMode(true)">
                        Modifier le dossier
                    </button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-bottom fw-bold text-primary">1. Symptômes Cliniques</div>
                        <div class="card-body">
                            <label class="form-label">Intensité Douleur Thoracique</label>
                            <select id="sym-pain" class="form-select mb-2">
                                <option value="0">Aucune</option>
                                <option value="1">Modérée</option>
                                <option value="2">Intense (Critique)</option>
                            </select>
                            <label class="form-label">Problèmes Respiratoires</label>
                            <select id="sym-breath" class="form-select mb-2">
                                <option value="0">Aucun</option>
                                <option value="1">Légers</option>
                                <option value="2">Sévères</option>
                            </select>
                            <div class="form-check mt-3">
                                <input type="checkbox" id="sym-sweat" class="form-check-input">
                                <label>Sueurs froides présentes</label>
                            </div>
                            <button onclick="saveSymptoms()" class="btn btn-outline-primary w-100 mt-3">Enregistrer Symptômes</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-bottom fw-bold text-primary">2. Résultats Examens</div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label>ECG</label>
                                    <select id="exam-ecg" class="form-select">
                                        <option value="0">Normal</option>
                                        <option value="1">Anormal</option>
                                        <option value="2">ST Élevé</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label>IRM</label>
                                    <select id="exam-mri" class="form-select">
                                        <option value="0">Normal</option>
                                        <option value="1">Anormal</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label>Cholestérol (mg/dl)</label>
                                    <input type="number" id="exam-tcho" class="form-control" placeholder="50-600" min="50" max="600">
                                </div>
                                <div class="col-6">
                                    <label>Pouls (bpm)</label>
                                    <input type="number" id="exam-pulse" class="form-control" placeholder="30-250" min="30" max="250">
                                </div>
                            </div>
                            <button onclick="saveExams()" class="btn btn-outline-primary w-100 mt-3">Enregistrer Examens</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0"><i class="fas fa-brain me-2"></i> Assistant Diagnostic (Règles / IA)</h4>
                </div>
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-5 border-end">
                            <label class="form-label fw-bold">Méthode de Diagnostic</label>
                            <select id="diag-method" class="form-select form-select-lg mb-3">
                                <option value="rules">Règles (Système Expert)</option>
                                <option value="random_forest">Random Forest (Recommandé)</option>
                                <option value="deep_learning">Deep Learning (Réseau de Neurones)</option>
                            </select>
                            <button onclick="launchDiagnostic()" class="btn btn-success w-100 btn-lg">
                                Lancer l'Analyse <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                        <div class="col-md-7">
                            <div id="diag-result" style="display:none;"></div>
                            <div id="diag-placeholder" class="text-center text-muted py-4">
                                <i class="fas fa-wave-square fa-3x mb-3"></i>
                                <p>En attente des données pour analyse...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PATIENT HOME -->
        <div id="vue-patient-home" class="hidden">
            <div id="patient-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT USER -->
    <div class="modal fade" id="editModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier utilisateur</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <input id="edit-nom" class="form-control mb-2" placeholder="Nom">
                    <input id="edit-prenom" class="form-control mb-2" placeholder="Prénom">
                    <input id="edit-email" class="form-control mb-2" placeholder="Email">
                    <select id="edit-role" class="form-select mb-2">
                        <option value="patient">Patient</option>
                        <option value="medecin">Médecin</option>
                        <option value="admin">Admin</option>
                    </select>
                    <input id="edit-pass" type="password" class="form-control" placeholder="Nouveau mot de passe (optionnel)">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveUserChanges()">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let editModal;

        document.addEventListener('DOMContentLoaded', async () => {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            const r = await fetch('/current_user');
            const data = await r.json();
            if (!data.user) { window.location.href = '/'; return; }
            const u = data.user;
            document.getElementById('user-info').innerHTML =
                `Connecté : <strong>${u.prenom} ${u.nom}</strong><br><span class="badge bg-secondary">${u.role}</span>`;

            if (u.role === 'admin') {
                document.getElementById('menu-admin').classList.remove('hidden');
                showSection('admin-users');
                loadUsers();
            } else if (u.role === 'medecin') {
                document.getElementById('menu-doctor').classList.remove('hidden');
                showSection('doc-patients');
                loadPatients();
            } else {
                document.getElementById('menu-patient').classList.remove('hidden');
                loadPatientDashboard();
            }
        });

        function showSection(id) {
            document.querySelectorAll('[id^="vue-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById('vue-' + id).classList.remove('hidden');
        }

        // ADMIN
        async function loadUsers() {
            const r = await fetch('/api/users');
            const d = await r.json();
            document.getElementById('table-users').innerHTML = d.map(u => `
                <tr>
                  <td>${u.nom} ${u.prenom}</td>
                  <td>${u.email}</td>
                  <td>${u.role}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1"
                      onclick="openEdit(${u.id},'${u.nom}','${u.prenom}','${u.email}','${u.role}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="delUser(${u.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>`).join('');
        }

        async function createUser() {
            await fetch('/users', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    nom:document.getElementById('new-nom').value,
                    prenom:document.getElementById('new-prenom').value,
                    email:document.getElementById('new-email').value,
                    password:document.getElementById('new-pass').value,
                    role:document.getElementById('new-role').value
                })
            });
            loadUsers();
        }

        async function delUser(id) {
            if (confirm('Supprimer ?')) {
                await fetch(`/users/${id}`, { method:'DELETE' });
                loadUsers();
            }
        }

        function openEdit(id,n,p,e,r) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-nom').value = n;
            document.getElementById('edit-prenom').value = p;
            document.getElementById('edit-email').value = e;
            document.getElementById('edit-role').value = r;
            document.getElementById('edit-pass').value = "";
            editModal.show();
        }

        async function saveUserChanges() {
            await fetch(`/users/${document.getElementById('edit-id').value}`, {
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    nom:document.getElementById('edit-nom').value,
                    prenom:document.getElementById('edit-prenom').value,
                    email:document.getElementById('edit-email').value,
                    role:document.getElementById('edit-role').value,
                    password:document.getElementById('edit-pass').value
                })
            });
            editModal.hide();
            loadUsers();
        }

        // MEDECIN
        async function loadPatients() {
            const r = await fetch('/api/patients_list');
            const d = await r.json();
            document.getElementById('table-patients').innerHTML = d.map(p => `
                <tr>
                  <td>
                    <span class="fw-bold">${p.nom} ${p.prenom}</span><br>
                    <small class="text-muted">${p.age} ans</small>
                  </td>
                  <td>${p.email}</td>
                  <td>${p.has_record
                        ? '<span class="text-success"><i class="fas fa-check-circle"></i> Complet</span>'
                        : '<span class="text-warning">Incomplet</span>'}
                  </td>
                  <td>
                    <button class="btn btn-primary btn-sm"
                            onclick="openRec(${p.id}, ${p.has_record ? 'true' : 'false'})">
                      Voir Dossier
                    </button>
                  </td>
                </tr>`).join('');
        }

        async function loadNewPatientForm() {
            showSection('doc-new-patient');
            const r = await fetch('/api/users_without_record');
            const u = await r.json();
            const s = document.getElementById('select-existing-user');
            s.innerHTML = '<option value="">-- Anonyme --</option>';
            u.forEach(x => {
                let o = document.createElement('option');
                o.value = x.id;
                o.text = `${x.prenom} ${x.nom}`;
                o.dataset.n = x.nom;
                o.dataset.p = x.prenom;
                s.add(o);
            });
        }

        function fillPatientForm() {
            const o = document.getElementById('select-existing-user').selectedOptions[0];
            if (o && o.value) {
                document.getElementById('pat-nom').value = o.dataset.n;
                document.getElementById('pat-prenom').value = o.dataset.p;
            }
        }

        async function createPatient() {
            const res = await fetch('/api/patients', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    user_id:document.getElementById('select-existing-user').value || null,
                    nom:document.getElementById('pat-nom').value,
                    prenom:document.getElementById('pat-prenom').value,
                    age:document.getElementById('pat-age').value,
                    sexe:document.getElementById('pat-sexe').value,
                    diabete:document.getElementById('pat-diabete').checked
                })
            });
            const d = await res.json();
            if (res.ok) {
                showSection('doc-patients');
                loadPatients();
            } else {
                alert(d.error);
            }
        }

        // ACTIVE / DESACTIVE les champs du dossier
        function toggleEditMode(edit) {
            const disabled = !edit;
            ['sym-pain','sym-breath','sym-sweat','exam-ecg','exam-mri','exam-tcho','exam-pulse']
              .forEach(id => {
                  const el = document.getElementById(id);
                  if (!el) return;
                  el.disabled = disabled;
              });

            if (edit) {
                document.getElementById('btn-edit-record').style.display = 'none';
            }
        }

        async function openRec(id, hasRecord) {
            document.getElementById('currentPatientId').value = id;

            if (!hasRecord) {
                // Pas de dossier encore : formulaire vierge
                showSection('doc-record');
                document.getElementById('record-title').innerText = "Nouveau dossier patient";

                ['sym-pain','sym-breath','exam-ecg','exam-mri','exam-tcho','exam-pulse'].forEach(x => {
                    const el = document.getElementById(x);
                    if (el) el.disabled = false;
                });
                document.getElementById('sym-pain').value = '0';
                document.getElementById('sym-breath').value = '0';
                document.getElementById('exam-ecg').value = '0';
                document.getElementById('exam-mri').value = '0';
                document.getElementById('exam-tcho').value = '';
                document.getElementById('exam-pulse').value = '';
                document.getElementById('sym-sweat').checked = false;

                document.getElementById('btn-edit-record').style.display = 'none';
                document.getElementById('diag-result').style.display = 'none';
                document.getElementById('diag-placeholder').style.display = 'block';
                return;
            }

            // Dossier existant : consultation d'abord
            const r = await fetch(`/api/patient_record/${id}`);
            const d = await r.json();
            if (d.error) {
                alert(d.error);
                return;
            }

            showSection('doc-record');
            document.getElementById('record-title').innerText =
                `Dossier de ${d.patient.prenom} ${d.patient.nom}`;

            if (d.symptoms) {
                document.getElementById('sym-pain').value = d.symptoms.chest_pain;
                document.getElementById('sym-breath').value = d.symptoms.breath_problems;
                document.getElementById('sym-sweat').checked = d.symptoms.cold_sweat;
            }
            if (d.exams) {
                document.getElementById('exam-ecg').value = d.exams.ecg;
                document.getElementById('exam-mri').value = d.exams.mri;
                document.getElementById('exam-tcho').value = d.exams.tcho;
                document.getElementById('exam-pulse').value = d.exams.pulse_rate;
            }

            toggleEditMode(false);
            document.getElementById('btn-edit-record').style.display = 'inline-block';
            document.getElementById('diag-result').style.display = 'none';
            document.getElementById('diag-placeholder').display = 'block';
        }

        async function saveSymptoms() {
            await fetch('/api/symptoms', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    patient_id:document.getElementById('currentPatientId').value,
                    chest_pain:document.getElementById('sym-pain').value,
                    breath_problems:document.getElementById('sym-breath').value,
                    cold_sweat:document.getElementById('sym-sweat').checked
                })
            });
            alert('Symptômes sauvegardés');
        }

        async function saveExams() {
            const res = await fetch('/api/exams', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    patient_id:document.getElementById('currentPatientId').value,
                    ecg:document.getElementById('exam-ecg').value,
                    mri:document.getElementById('exam-mri').value,
                    tcho:document.getElementById('exam-tcho').value,
                    pulse_rate:document.getElementById('exam-pulse').value
                })
            });
            const d = await res.json();
            if (res.ok) alert('Examens sauvegardés'); else alert(d.error);
        }

        async function launchDiagnostic() {
            const ph = document.getElementById('diag-placeholder');
            const res = document.getElementById('diag-result');
            ph.style.display = 'none';
            res.style.display = 'block';
            res.innerHTML = '<div class="text-center text-primary"><div class="spinner-border"></div><p>Analyse des données...</p></div>';

            const patientId = document.getElementById('currentPatientId').value;
            const method = document.getElementById('diag-method').value;

            const r = await fetch(`/api/diagnose/${patientId}`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ method: method })
            });
            const data = await r.json();

            if (data.error) {
                res.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            const d = data.result;
            const color = d.hospitalisation ? 'danger' : 'success';
            const factors = d.explanation
                ? d.explanation.map(f => `<span class="factor-tag"><i class="fas fa-exclamation-triangle text-warning"></i> ${f}</span>`).join('')
                : '';

            res.innerHTML = `
                <div class="alert alert-${color} border-0 shadow-sm">
                    <h4 class="alert-heading fw-bold">${d.attack_status}</h4>
                    <hr>
                    <p class="lead mb-0">${d.decision}</p>
                </div>
                <div class="ai-panel mt-3">
                    <h6 class="text-primary fw-bold mb-2"><i class="fas fa-microchip"></i> Facteurs identifiés :</h6>
                    <div>${factors || '<span class="text-muted text-sm">Aucun facteur aggravant majeur détecté.</span>'}</div>
                </div>
            `;
        }

        // PATIENT DASHBOARD (inchangé)
        async function loadPatientDashboard() {
            showSection('patient-home');
            const c = document.getElementById('patient-content');
            const r = await fetch('/api/my_info');
            const d = await r.json();

            if (!d.found) {
                c.innerHTML = '<div class="alert alert-warning text-center">Votre dossier est vide pour le moment.</div>';
                return;
            }

            const last = d.historique[0] || null;
            let heroCard = '';
            if (last) {
                const statusColor = last.result.includes('Normal') ? 'success' : 'danger';
                heroCard = `
                    <div class="patient-header shadow">
                        <h1 class="display-5 fw-bold mb-2">Bonjour, ${d.prenom}</h1>
                        <div class="bg-white text-dark p-4 rounded-3 mt-4 shadow-sm">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="text-uppercase text-muted ls-1">Dernier Diagnostic (${last.date})</h6>
                                    <h2 class="text-${statusColor} fw-bold mb-1">${last.result}</h2>
                                    <p class="lead mb-0">${last.decision}</p>
                                </div>
                                <div class="col-md-4 text-end d-none d-md-block">
                                    <i class="fas fa-heartbeat fa-4x text-${statusColor} opacity-25"></i>
                                </div>
                            </div>
                            <hr>
                            <small class="text-muted"><strong>Détails de l'analyse :</strong> ${last.details || 'Analyse standard'}</small>
                        </div>
                    </div>
                `;
            } else {
                heroCard = `<div class="patient-header"><h1 class="display-6">Bonjour ${d.prenom}</h1><p>Aucune donnée d'analyse disponible.</p></div>`;
            }

            const historyHtml = d.historique.map(h => `
                <div class="col-md-6 mb-4">
                    <div class="card diag-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-light text-dark border">${h.date}</span>
                            </div>
                            <h5 class="card-title ${h.result.includes('Normal')?'text-success':'text-danger'}">${h.result}</h5>
                            <p class="card-text text-muted small">${h.decision}</p>
                            <div class="mt-3 p-2 bg-light rounded text-muted small fst-italic">
                                "${h.details}"
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            c.innerHTML = `
                ${heroCard}
                <div class="row">
                    <div class="col-12 mb-4">
                        <h4 class="mb-3 text-muted">Historique des analyses</h4>
                        <div class="row">
                            ${historyHtml || '<p class="text-muted">Aucun historique.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
